{% extends "base.html" %}

{% block content %}
<div class="upload-page">
    <div class="upload-container">
        <!-- Initial Upload Section -->
        <div class="upload-init-section" id="uploadInit">
            <div class="upload-header">
                <h1><i class="fas fa-magic"></i> Restore Your Old Photos</h1>
                <p class="subtitle">Upload an old photo to bring it back to life</p>
            </div>
            
            <div class="upload-button-container">
                <button class="upload-main-button" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Old Image
                </button>
                <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.bmp,.tiff,.webp" style="display: none;">
                <p class="upload-hint">Supports: JPG, PNG, BMP, TIFF, WEBP â€¢ Max 10MB</p>
            </div>
        </div>

        <!-- After Upload Section -->
        <div class="upload-preview-section" id="uploadPreview" style="display: none;">
            <!-- Header -->
            <div class="preview-header">
                <h2><i class="fas fa-image"></i> Ready to Restore</h2>
                <p class="subtitle">Review your image and select restoration model</p>
            </div>

            <!-- Image Display (like results page) -->
            <div class="preview-image-section">
                <div class="image-wrapper">
                    <div class="image-label">
                        <i class="fas fa-image"></i>
                        <span>Image to Restore</span>
                    </div>
                    <img id="previewImage" src="" alt="Uploaded Image" class="preview-image">
                </div>
            </div>



            
                        <!-- Model Selection -->
            <div class="model-selection-section">
                <div class="section-title">
                    <i class="fas fa-cogs"></i>
                    <h3>Select Restoration Model</h3>
                </div>
                
                <div class="model-dropdown-container">
                    <div class="dropdown-header">
                        <i class="fas fa-robot"></i>
                        <span>Restoration Model</span>
                    </div>
                    
                    <select id="modelSelect" class="model-select">
                        <option value="quick" selected>Quick Clean (ZeroScratches Model)</option>
                        <option value="deep" disabled>Deep Restoration (BPBTL Model) - Coming Soon</option>
                    </select>
    
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="action-section">
                <div class="button-group">
                    <button class="btn remove-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        Remove
                    </button>
                    <button class="btn change-btn" id="changeBtn">
                        <i class="fas fa-sync"></i>
                        Change Image
                    </button>
                    <button class="btn process-btn" id="processBtn">
                        <i class="fas fa-magic"></i>
                        Process Image
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for Backend -->
<form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('process_image') }}" style="display: none;">
    <input type="file" name="image" id="formFileInput">
    <input type="hidden" name="model" id="formModelInput" value="quick">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const uploadInit = document.getElementById('uploadInit');
    const uploadPreview = document.getElementById('uploadPreview');
    const removeBtn = document.getElementById('removeBtn');
    const changeBtn = document.getElementById('changeBtn');
    const processBtn = document.getElementById('processBtn');
    const modelSelect = document.getElementById('modelSelect');
    const formModelInput = document.getElementById('formModelInput');
    const formFileInput = document.getElementById('formFileInput');
    const uploadForm = document.getElementById('uploadForm');
    
    let selectedModel = 'quick';
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });
    
    function handleFileUpload(file) {
        // Validate
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('File too large. Max 10MB');
            return;
        }
        
        // Read and display image
        const reader = new FileReader();
        reader.onload = function(event) {
            previewImage.src = event.target.result;
            
            // Switch to preview section
            uploadInit.style.display = 'none';
            uploadPreview.style.display = 'block';
            
            // Scroll to preview
            uploadPreview.scrollIntoView({ behavior: 'smooth' });
        };
        reader.readAsDataURL(file);
    }
    
    // Model selection
    formModelInput.value = selectedModel;
    
    // Disable deep model selection
    modelSelect.addEventListener('change', function() {
        if (this.value === 'deep') {
            alert('Deep Restoration is coming soon. Please select Quick Clean for now.');
            this.value = 'quick';
        }
        selectedModel = this.value;
        formModelInput.value = selectedModel;
    });
    
    // Remove button
    removeBtn.addEventListener('click', function() {
        // Reset everything
        fileInput.value = '';
        previewImage.src = '';
        selectedModel = 'quick';
        formModelInput.value = 'quick';
        modelSelect.value = 'quick';
        
        // Switch back to upload section
        uploadPreview.style.display = 'none';
        uploadInit.style.display = 'block';
    });
    
    // Change button
    changeBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    // Process button
    processBtn.addEventListener('click', function() {
        if (!fileInput.files[0]) {
            alert('Please select an image first');
            return;
        }
        
        // Show loading state
        const originalHtml = processBtn.innerHTML;
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        processBtn.disabled = true;
        
        // Prepare form data
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(fileInput.files[0]);
        formFileInput.files = dataTransfer.files;
        
        // Submit form
        uploadForm.submit();
    });
    
    // Drag and drop support
    const uploadContainer = document.querySelector('.upload-container');
    
    uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadContainer.classList.add('dragover');
    });
    
    uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadContainer.classList.remove('dragover');
    });
    
    uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadContainer.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });
});
</script>
{% endblock %}