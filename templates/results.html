{% extends "base.html" %}

{% block content %}
<div class="results-container">
    <!-- Header -->
    <div class="results-header">
        <h1><i class="fas fa-check-circle"></i> Restoration Complete!</h1>
    </div>

    <!-- Image with Download Button -->
    <div class="image-section">
        <div class="image-wrapper">
            {% if restored_image %}
                <img src="{{ url_for('static', filename='results/' + restored_image) }}" 
                     alt="Restored Image" 
                     class="restored-image"
                     id="editableImage"
                     onerror="this.src='https://via.placeholder.com/800x600/393E46/DFD0B8?text=Restored+Image'">
                <button class="download-corner-btn" onclick="downloadEditedImage()">
                    <i class="fas fa-download"></i>
                </button>
            {% else %}
                <div class="placeholder-image">
                    <i class="fas fa-image"></i>
                    <p>Restored image not found</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Section -->
    <div class="edit-section">
        <h2><i class="fas fa-sliders-h"></i> Edit Image</h2>
        <p class="edit-subtitle">Adjust the image settings and see changes in real-time</p>
        
        <div class="edit-controls">
            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Brightness</span>
                    <span class="slider-value" id="brightnessValue">100%</span>
                </div>
                <input type="range" 
                       min="0" 
                       max="200" 
                       value="100" 
                       class="slider" 
                       id="brightnessSlider"
                       oninput="updateBrightness(this.value)">
                <div class="slider-ticks">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                    <span>150%</span>
                    <span>200%</span>
                </div>
            </div>

            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Contrast</span>
                    <span class="slider-value" id="contrastValue">100%</span>
                </div>
                <input type="range" 
                       min="0" 
                       max="200" 
                       value="100" 
                       class="slider" 
                       id="contrastSlider"
                       oninput="updateContrast(this.value)">
                <div class="slider-ticks">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                    <span>150%</span>
                    <span>200%</span>
                </div>
            </div>

            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Saturation</span>
                    <span class="slider-value" id="saturationValue">100%</span>
                </div>
                <input type="range" 
                       min="0" 
                       max="200" 
                       value="100" 
                       class="slider" 
                       id="saturationSlider"
                       oninput="updateSaturation(this.value)">
                <div class="slider-ticks">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                    <span>150%</span>
                    <span>200%</span>
                </div>
            </div>

            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Temperature</span>
                    <span class="slider-value" id="temperatureValue">0</span>
                </div>
                <input type="range" 
                       min="-100" 
                       max="100" 
                       value="0" 
                       class="slider" 
                       id="temperatureSlider"
                       oninput="updateTemperature(this.value)">
                <div class="slider-ticks">
                    <span>Cool</span>
                    <span>Neutral</span>
                    <span>Warm</span>
                </div>
            </div>

            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Sharpness</span>
                    <span class="slider-value" id="sharpnessValue">0</span>
                </div>
                <input type="range" 
                       min="0" 
                       max="10" 
                       value="0" 
                       step="0.1"
                       class="slider" 
                       id="sharpnessSlider"
                       oninput="updateSharpness(this.value)">
                <div class="slider-ticks">
                    <span>Soft</span>
                    <span>Medium</span>
                    <span>Sharp</span>
                </div>
            </div>

            <div class="slider-control">
                <div class="slider-header">
                    <span class="slider-label">Vignette</span>
                    <span class="slider-value" id="vignetteValue">0%</span>
                </div>
                <input type="range" 
                       min="0" 
                       max="50" 
                       value="0" 
                       class="slider" 
                       id="vignetteSlider"
                       oninput="updateVignette(this.value)">
                <div class="slider-ticks">
                    <span>0%</span>
                    <span>25%</span>
                    <span>50%</span>
                </div>
            </div>
        </div>

        <div class="edit-buttons">
            <button class="btn secondary-btn" onclick="resetFilters()">
                <i class="fas fa-undo"></i> Reset All
            </button>
            <button class="btn" onclick="applyFilters()">
                <i class="fas fa-check"></i> Apply Changes
            </button>
        </div>
    </div>

    <!-- Restoration Details -->
    <div class="details-section">
        <div class="details-grid">
            <div class="detail-item">
                <span class="detail-label">Model Used:</span>
                <span class="detail-value">
                    {% if model_used == 'quick' %}
                        Quick Clean Model
                    {% else %}
                        Deep Restoration Model
                    {% endif %}
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Processing Time:</span>
                <span class="detail-value">~25 seconds</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Date Restored:</span>
                <span class="detail-value" id="currentDate"></span>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn secondary-btn" onclick="window.location.href='{{ url_for('home') }}'">
            <i class="fas fa-arrow-left"></i> Restore Another
        </button>
        <button class="btn" onclick="window.location.href='{{ url_for('history') }}'">
            <i class="fas fa-history"></i> View History
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const now = new Date();
    document.getElementById('currentDate').textContent = 
        now.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        });
    
    // Store original image source
    const img = document.getElementById('editableImage');
    if (img) {
        img.dataset.originalSrc = img.src;
    }
});

let currentFilters = {
    brightness: 100,
    contrast: 100,
    saturation: 100,
    temperature: 0,
    sharpness: 0,
    vignette: 0
};

function updateBrightness(value) {
    currentFilters.brightness = parseInt(value);
    document.getElementById('brightnessValue').textContent = value + '%';
    applyLiveFilters();
}

function updateContrast(value) {
    currentFilters.contrast = parseInt(value);
    document.getElementById('contrastValue').textContent = value + '%';
    applyLiveFilters();
}

function updateSaturation(value) {
    currentFilters.saturation = parseInt(value);
    document.getElementById('saturationValue').textContent = value + '%';
    applyLiveFilters();
}

function updateTemperature(value) {
    currentFilters.temperature = parseInt(value);
    document.getElementById('temperatureValue').textContent = value;
    applyLiveFilters();
}

function updateSharpness(value) {
    currentFilters.sharpness = parseFloat(value);
    document.getElementById('sharpnessValue').textContent = parseFloat(value).toFixed(1);
    applyLiveFilters();
}

function updateVignette(value) {
    currentFilters.vignette = parseInt(value);
    document.getElementById('vignetteValue').textContent = value + '%';
    applyLiveFilters();
}

function applyLiveFilters() {
    const img = document.getElementById('editableImage');
    if (!img) return;
    
    // Apply CSS filters
    const filterString = `
        brightness(${currentFilters.brightness}%) 
        contrast(${currentFilters.contrast}%) 
        saturate(${currentFilters.saturation}%)
    `;
    
    img.style.filter = filterString;
    
    // Apply temperature (using CSS hue-rotate and sepia)
    const temp = currentFilters.temperature;
    let tempFilter = '';
    if (temp > 0) {
        // Warm (add sepia and adjust hue)
        tempFilter = `sepia(${temp * 0.2}%) hue-rotate(${temp * 0.2}deg)`;
    } else if (temp < 0) {
        // Cool (add blue tint)
        tempFilter = `hue-rotate(${temp * 1.8}deg)`;
    }
    
    if (tempFilter) {
        img.style.filter += ' ' + tempFilter;
    }
    
    // Apply vignette effect (using CSS radial gradient overlay)
    applyVignetteEffect();
    
    // Apply sharpness (using CSS blur with negative value)
    if (currentFilters.sharpness > 0) {
        const sharpnessBlur = 0.5 - (currentFilters.sharpness * 0.05);
        img.style.filter += ` blur(${sharpnessBlur}px)`;
    }
}

function applyVignetteEffect() {
    const img = document.getElementById('editableImage');
    if (!img) return;
    
    const vignette = currentFilters.vignette;
    if (vignette > 0) {
        // Create vignette overlay
        const overlayId = 'vignetteOverlay';
        let overlay = document.getElementById(overlayId);
        
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = overlayId;
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.pointerEvents = 'none';
            overlay.style.borderRadius = '10px';
            overlay.style.zIndex = '5';
            
            const wrapper = img.parentElement;
            wrapper.style.position = 'relative';
            wrapper.appendChild(overlay);
        }
        
        const opacity = vignette / 200; // Reduced opacity for subtle effect
        overlay.style.background = `radial-gradient(circle, transparent 30%, rgba(0, 0, 0, ${opacity}) 100%)`;
    } else {
        // Remove vignette overlay
        const overlay = document.getElementById('vignetteOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
}

function resetFilters() {
    // Reset slider values
    document.getElementById('brightnessSlider').value = 100;
    document.getElementById('contrastSlider').value = 100;
    document.getElementById('saturationSlider').value = 100;
    document.getElementById('temperatureSlider').value = 0;
    document.getElementById('sharpnessSlider').value = 0;
    document.getElementById('vignetteSlider').value = 0;
    
    // Reset display values
    document.getElementById('brightnessValue').textContent = '100%';
    document.getElementById('contrastValue').textContent = '100%';
    document.getElementById('saturationValue').textContent = '100%';
    document.getElementById('temperatureValue').textContent = '0';
    document.getElementById('sharpnessValue').textContent = '0';
    document.getElementById('vignetteValue').textContent = '0%';
    
    // Reset current filters
    currentFilters = {
        brightness: 100,
        contrast: 100,
        saturation: 100,
        temperature: 0,
        sharpness: 0,
        vignette: 0
    };
    
    // Reset image
    const img = document.getElementById('editableImage');
    if (img) {
        img.style.filter = 'none';
        
        // Remove vignette overlay
        const overlay = document.getElementById('vignetteOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    
    showNotification('Filters reset to default');
}

function applyFilters() {
    showNotification('Changes applied successfully!');
}

async function downloadEditedImage() {
    const img = document.getElementById('editableImage');
    if (!img) {
        alert('No image available for download.');
        return;
    }
    
    const downloadBtn = event.currentTarget;
    const originalHtml = downloadBtn.innerHTML;
    
    // Show loading state
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;
    
    try {
        // Create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        
        // Wait for image to load
        await new Promise((resolve) => {
            if (img.complete) {
                resolve();
            } else {
                img.onload = resolve;
            }
        });
        
        // Draw image with current filters
        ctx.filter = window.getComputedStyle(img).filter || 'none';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        // Apply vignette if present
        if (currentFilters.vignette > 0) {
            const vignetteOpacity = currentFilters.vignette / 200;
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width / 2
            );
            gradient.addColorStop(0, `rgba(0, 0, 0, 0)`);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${vignetteOpacity})`);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Convert to data URL and download
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'edited_restored_image.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Edited image downloaded successfully!');
        
    } catch (error) {
        console.error('Download error:', error);
        
        // Fallback: Download original image
        {% if restored_image %}
            const imageUrl = "{{ url_for('static', filename='results/' + restored_image) }}";
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = "restored_{{ restored_image }}";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Original image downloaded (edits not applied)');
        {% else %}
            alert('Error downloading edited image. Please try again.');
        {% endif %}
    } finally {
        // Restore button
        downloadBtn.innerHTML = originalHtml;
        downloadBtn.disabled = false;
    }
}

function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent);
        color: var(--background);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        box-shadow: var(--box-shadow-hover);
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Add CSS animations for notification
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}