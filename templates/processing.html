{% extends "base.html" %}

{% block content %}
<div class="processing-container">
    <div class="processing-header">
        <h1><i class="fas fa-cog fa-spin processing-icon"></i> Restoring Your Memory</h1>
        <p class="subtitle">Our AI is working its magic to restore your photo</p>
    </div>

    <div class="processing-content">
        <!-- Progress Section -->
        <div class="progress-section">
            <div class="progress-header">
                <h3>Progress</h3>
                <div class="progress-time">
                    <i class="fas fa-clock"></i>
                    <span id="timeRemaining">Estimated time: 15-30 seconds</span>
                </div>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-percentage">
                    <span id="percentage">0%</span>
                </div>
            </div>
            
            <div class="progress-steps">
                <div class="step active">
                    <span class="step-number">1</span>
                    <span class="step-text">Uploading & Analyzing</span>
                    <i class="fas fa-check step-check"></i>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-text">Noise Reduction</span>
                    <i class="fas fa-check step-check"></i>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-text">Color Correction</span>
                    <i class="fas fa-check step-check"></i>
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    <span class="step-text">Detail Enhancement</span>
                    <i class="fas fa-check step-check"></i>
                </div>
                <div class="step">
                    <span class="step-number">5</span>
                    <span class="step-text">Finalizing Restoration</span>
                    <i class="fas fa-check step-check"></i>
                </div>
            </div>
        </div>

        <!-- Model Info -->
        <div class="model-info">
            <div class="model-badge">
                <i class="fas fa-robot"></i>
                <span class="model-name" id="modelName">{{ model_used|default('quick')|title }} Model</span>
            </div>
            <p class="model-description">
                {% if model_used == 'deep' %}
                Using Deep Restoration model for maximum detail recovery and quality enhancement.
                {% else %}
                Using Quick Clean model for fast restoration of common issues like scratches and dust.
                {% endif %}
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn secondary-btn" onclick="window.location.href='{{ url_for('home') }}'">
                <i class="fas fa-arrow-left"></i> Cancel & Return
            </button>
            <button class="btn" id="refreshBtn" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
        </div>
    </div>

    <!-- Hidden redirect form -->
    <form id="redirectForm" action="{{ url_for('results') }}" method="GET" style="display: none;"></form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobId = '{{ job_id }}';
    console.log("Job ID for polling:", jobId);
    
    if (!jobId) {
        console.error("No job ID found!");
        alert("No processing job found. Please upload an image first.");
        window.location.href = '/';
        return;
    }
    
    let checkInterval;
    let simulationInterval;
    let progress = 0;
    const progressBar = document.getElementById('progressFill');
    const percentage = document.getElementById('percentage');
    const steps = document.querySelectorAll('.step');
    const timeRemaining = document.getElementById('timeRemaining');
    
    // Update progress bar function
    function updateProgressBar(value) {
        progress = Math.min(value, 100);
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        if (percentage) {
            percentage.textContent = `${Math.round(progress)}%`;
        }
        
        // Update steps
        steps.forEach((step, index) => {
            if (progress >= (index + 1) * 20) {
                step.classList.add('active');
            }
        });
        
        // Update time estimate
        if (timeRemaining) {
            const remaining = Math.max(0, Math.floor((100 - progress) / 3));
            timeRemaining.textContent = `Estimated time remaining: ${remaining} seconds`;
        }
    }
    
    // Start simulation progress (for UX)
    function startSimulation() {
        simulationInterval = setInterval(() => {
            if (progress < 90) { // Only simulate up to 90%
                progress += 2;
                updateProgressBar(progress);
            } else {
                clearInterval(simulationInterval);
            }
        }, 1000);
    }
    
    // Check processing status from server
    function checkProcessingStatus() {
        fetch(`/api/processing-status/${jobId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Status response:", data);
                
                if (data.status === 'completed') {
                    // Stop checking
                    clearInterval(checkInterval);
                    clearInterval(simulationInterval);
                    
                    // Set to 100%
                    updateProgressBar(100);
                    
                    // Add small delay for UX, then redirect
                    setTimeout(() => {
                        window.location.href = '/results';
                    }, 1500);
                    
                } else if (data.status === 'error') {
                    clearInterval(checkInterval);
                    clearInterval(simulationInterval);
                    alert('Processing failed: ' + (data.error || 'Unknown error'));
                    window.location.href = '/';
                } else if (data.status === 'processing') {
                    // Model is processing, update progress to 50-90% range
                    if (progress < 50) {
                        updateProgressBar(50);
                    }
                    // Continue polling
                }
                // If pending or processing, continue waiting
            })
            .catch(error => {
                console.error('Error checking status:', error);
                // Don't stop on network errors, just log
            });
    }
    
    // Start simulation
    startSimulation();
    
    // Start checking every 3 seconds
    checkInterval = setInterval(checkProcessingStatus, 3000);
    
    // Initial check
    checkProcessingStatus();
    
    // Add event listener for the refresh button
    document.getElementById('refreshBtn')?.addEventListener('click', function() {
        checkProcessingStatus();
    });
});
</script>
{% endblock %}